<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title th:text="'Factura ' + ${invoice.invoiceNumber}">Factura</title>
    <style>
        @page {
            size: A4;
            margin: 25pt 25pt 60pt 25pt;
        }

        @page :first {
            margin-bottom: 180pt;
        }

        body {
            font-family: 'Roboto', sans-serif;
            font-size: 8pt;
            color: #333;
            line-height: 1.4;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
        }

        .header-section {
            display: table;
            width: 100%;
            margin-bottom: 15pt;
        }

        .logo-space {
            display: table-cell;
            width: 25%;
            vertical-align: top;
            height: 45pt;
        }

        .company-info {
            display: table-cell;
            width: 45%;
            text-align: center;
            vertical-align: top;
        }

        .company-name {
            font-size: 12pt;
            font-weight: 700;
            display: block;
            margin-bottom: 2pt;
        }

        .company-nif {
            font-size: 9pt;
            font-weight: 700;
            display: block;
            margin-bottom: 2pt;
        }

        .company-address {
            font-size: 7pt;
            color: #666;
            display: block;
        }

        .qr-space {
            display: table-cell;
            width: 25%;
            vertical-align: top;
            text-align: right;
            height: 45pt;
        }

        .meta-section {
            margin-bottom: 10pt;
        }

        .meta-item {
            display: inline-block;
            margin-right: 20pt;
        }

        .meta-label {
            font-size: 7pt;
            color: #666;
            display: block;
        }

        .meta-value {
            font-size: 9pt;
            font-weight: 700;
            display: block;
        }

        .client-section {
            margin-bottom: 10pt;
            border: 1pt solid #999;
        }

        .client-title {
            font-size: 8pt;
            font-weight: 700;
            background-color: #f5f5f5;
            padding: 3pt;
        }

        .client-content {
            padding: 5pt;
        }

        .client-name {
            font-size: 9pt;
            font-weight: 700;
            display: block;
        }

        .client-text {
            font-size: 7pt;
            color: #666;
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10pt;
        }

        thead tr {
            background-color: #f5f5f5;
        }

        thead {
            display: table-header-group;
        }

        th {
            text-align: center;
            font-size: 7pt;
            font-weight: 700;
            border: 1pt solid #999;
            padding: 3pt;
        }

        td {
            font-size: 7pt;
            padding: 2pt;
            border: 1pt solid #999;
            border-top: none;
            vertical-align: top;
        }

        tr {
            page-break-inside: avoid;
        }

        .col-desc {
            width: 42%;
            text-align: left;
            padding-left: 3pt;
        }

        .col-uds {
            width: 8%;
            text-align: center;
        }

        .col-dto {
            width: 8%;
            text-align: center;
        }

        .col-price {
            width: 14%;
            text-align: right;
        }

        .col-iva {
            width: 8%;
            text-align: center;
        }

        .col-importe {
            width: 20%;
            text-align: right;
            padding-right: 3pt;
        }

        .col-date {
            width: 10%;
            text-align: center;
        }

        .col-plate {
            width: 10%;
            text-align: center;
        }

        .col-desc-transport {
            width: 32%;
            text-align: left;
            padding-left: 3pt;
        }

        .col-zone {
            width: 10%;
            text-align: center;
        }

        .col-price-tr {
            width: 14%;
            text-align: right;
        }

        .col-gas {
            width: 8%;
            text-align: center;
        }

        .col-importe-tr {
            width: 16%;
            text-align: right;
            padding-right: 3pt;
        }

        .footer-section {
            display: table;
            width: 100%;
            margin-top: 10pt;
            position: fixed;
            bottom: 70pt;
            left: 25pt;
            right: 25pt;
        }

        .observaciones {
            display: table-cell;
            width: 55%;
            vertical-align: top;
        }

        .observaciones-label {
            font-size: 7pt;
            font-weight: 700;
            color: #666;
            display: block;
            margin-bottom: 2pt;
        }

        .observaciones-text {
            font-size: 7pt;
            display: block;
        }

        .totals-box {
            display: table-cell;
            width: 40%;
            vertical-align: top;
        }

        .total-row {
            display: table;
            width: 100%;
            padding: 2pt 0;
        }

        .total-label {
            display: table-cell;
            font-size: 10pt;
            width: 60%;
        }

        .total-value {
            display: table-cell;
            font-size: 10pt;
            text-align: right;
            width: 40%;
        }

        .grand-total {
            display: table;
            width: 100%;
            padding-top: 4pt;
            margin-top: 4pt;
            border-top: 1pt solid #999;
        }

        .grand-total-label {
            display: table-cell;
            font-size: 12pt;
            font-weight: 700;
            color: #c00000;
            width: 60%;
        }

        .grand-total-value {
            display: table-cell;
            font-size: 12pt;
            font-weight: 700;
            color: #c00000;
            text-align: right;
            width: 40%;
        }

        .verifactu-footer {
            text-align: center;
            font-size: 10pt;
            color: #333;
            margin-top: 20pt;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header: Logo | Company | QR - NO BORDERS -->
        <div class="header-section">
            <div class="logo-space">
                <img th:if="${company.logoUrl != null and company.logoUrl != ''}" th:src="${company.logoUrl}" alt="Logo"
                    style="max-width: 100%; max-height: 45pt; object-fit: contain;" />
            </div>
            <div class="company-info">
                <span class="company-name" th:text="${company.businessName}">EMPRESA S.L.</span>
                <span class="company-nif" th:text="${company.taxId}">B12345678</span>
                <span class="company-address"
                    th:text="${company.address + (company.postalCode != null ? ', ' + company.postalCode : '') + (company.city != null ? ' ' + company.city : '') + (company.province != null and company.province != '' ? ' (' + company.province + ')' : '')}">Dirección</span>
                <span class="company-address" th:if="${company.phone != null and company.phone != ''}"
                    th:text="${company.phone}">Teléfono</span>
                <span class="company-address" th:if="${company.email != null and company.email != ''}"
                    th:text="${company.email}">Email</span>
            </div>
            <div class="qr-space">
                <!-- Future: QR Code -->
            </div>
        </div>

        <!-- Invoice Meta - Simple inline, no heavy borders -->
        <div class="meta-section">
            <div class="meta-item">
                <span class="meta-label">FACTURA Nº:</span>
                <span class="meta-value" th:text="${invoice.invoiceNumber}">001/2024</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">FECHA:</span>
                <span class="meta-value"
                    th:text="${#temporals.format(invoice.issueDate, 'dd/MM/yyyy')}">01/01/2024</span>
            </div>
            <div class="meta-item" th:if="${invoice.settlementNumber}">
                <span class="meta-label">LIQUIDACIÓN Nº:</span>
                <span class="meta-value" th:text="${invoice.settlementNumber}">EXP-001</span>
            </div>
        </div>

        <!-- Client Box - Simple border -->
        <div class="client-section">
            <div class="client-title">Datos del cliente</div>
            <div class="client-content">
                <span class="client-name" th:text="${client.businessName}">Cliente</span>
                <span class="client-text" th:if="${client.taxId}" th:text="${client.taxId}">NIF</span>
                <span class="client-text"
                    th:text="${client.address + ', ' + client.postalCode + ' ' + client.city + ' - ' + client.province}">Dirección</span>
            </div>
        </div>

        <!-- Items Table -->
        <table>
            <thead>
                <tr>
                    <!-- Transport Invoice Headers -->
                    <th th:if="${isTransportInvoice}" class="col-date">FECHA</th>
                    <th th:if="${isTransportInvoice}" class="col-plate">MATRÍCULA</th>
                    <th th:if="${isTransportInvoice}" class="col-desc-transport">CONCEPTO</th>
                    <th th:if="${isTransportInvoice}" class="col-zone">ZONA</th>
                    <th th:if="${isTransportInvoice}" class="col-price-tr">PRECIO</th>
                    <th th:if="${isTransportInvoice}" class="col-gas">% GAS</th>
                    <th th:if="${isTransportInvoice}" class="col-importe-tr">IMPORTE</th>

                    <!-- Standard Invoice Headers -->
                    <th th:unless="${isTransportInvoice}" class="col-desc">Descripción producto/servicio</th>
                    <th th:unless="${isTransportInvoice}" class="col-uds">Uds</th>
                    <th th:unless="${isTransportInvoice}" class="col-dto">Dto%</th>
                    <th th:unless="${isTransportInvoice}" class="col-price">Precio</th>
                    <th th:unless="${isTransportInvoice}" class="col-iva">IVA%</th>
                    <th th:unless="${isTransportInvoice}" class="col-importe">Importe</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${invoice.items}">
                    <!-- Transport Columns -->
                    <td th:if="${isTransportInvoice}" class="col-date"
                        th:text="${item.itemDate != null ? #temporals.format(item.itemDate, 'dd/MM/yyyy') : ''}"></td>
                    <td th:if="${isTransportInvoice}" class="col-plate" th:text="${item.vehiclePlate ?: ''}"></td>
                    <td th:if="${isTransportInvoice}" class="col-desc-transport" th:text="${item.description}"></td>
                    <td th:if="${isTransportInvoice}" class="col-zone" th:text="${item.zone ?: ''}"></td>
                    <td th:if="${isTransportInvoice}" class="col-price-tr"
                        th:text="${#numbers.formatCurrency(item.price)}"></td>
                    <td th:if="${isTransportInvoice}" class="col-gas"
                        th:text="${item.gasPercentage != null ? item.gasPercentage : ''}"></td>
                    <td th:if="${isTransportInvoice}" class="col-importe-tr"
                        th:text="${#numbers.formatCurrency(item.subtotal)}"></td>

                    <!-- Standard Columns -->
                    <td th:unless="${isTransportInvoice}" class="col-desc" th:text="${item.description}"></td>
                    <td th:unless="${isTransportInvoice}" class="col-uds" th:text="${item.units}"></td>
                    <td th:unless="${isTransportInvoice}" class="col-dto"
                        th:text="${item.discountPercentage != null ? item.discountPercentage : ''}"></td>
                    <td th:unless="${isTransportInvoice}" class="col-price"
                        th:text="${#numbers.formatCurrency(item.price)}"></td>
                    <td th:unless="${isTransportInvoice}" class="col-iva" th:text="${item.vatPercentage}"></td>
                    <td th:unless="${isTransportInvoice}" class="col-importe"
                        th:text="${#numbers.formatCurrency(item.subtotal)}"></td>
                </tr>
            </tbody>
        </table>

        <!-- Footer: Observaciones + Totals -->
        <div class="footer-section">
            <div class="observaciones">
                <span class="observaciones-label">Observaciones / Datos de pago:</span>
                <span th:if="${company.iban}" class="observaciones-text"
                    th:text="'IBAN: ' + ${company.iban}">IBAN</span>
                <span th:if="${invoice.notes}" class="observaciones-text" th:text="${invoice.notes}">Notas</span>
            </div>

            <div class="totals-box">
                <div class="total-row">
                    <span class="total-label">Base imponible:</span>
                    <span class="total-value" th:text="${#numbers.formatCurrency(invoice.baseAmount)}">0,00 €</span>
                </div>
                <div class="total-row">
                    <span class="total-label" th:text="'IVA (' + ${invoice.items[0].vatPercentage} + '%):'">IVA
                        (21%):</span>
                    <span class="total-value"
                        th:text="${#numbers.formatCurrency(invoice.totalAmount - invoice.baseAmount + (invoice.irpfAmount ?: 0) - (invoice.reAmount ?: 0))}">0,00€</span>
                </div>
                <div class="total-row" th:if="${invoice.rePercentage > 0}">
                    <span class="total-label" th:text="'RE (' + ${invoice.rePercentage} + '%):'">RE</span>
                    <span class="total-value" th:text="${#numbers.formatCurrency(invoice.reAmount ?: 0)}">0,00 €</span>
                </div>
                <div class="total-row" th:if="${invoice.irpfPercentage > 0}">
                    <span class="total-label" th:text="'IRPF (' + ${invoice.irpfPercentage} + '%):'">IRPF</span>
                    <span class="total-value"
                        th:text="'-' + ${#numbers.formatCurrency(invoice.irpfAmount ?: 0)}">0,00€</span>
                </div>
                <div class="grand-total">
                    <span class="grand-total-label">TOTAL:</span>
                    <span class="grand-total-value"
                        th:text="${#numbers.formatCurrency(invoice.totalAmount)}">0,00€</span>
                </div>
            </div>
        </div>

        <!-- VeriFactu Footer - DISABLED TEMPORARILY
        <div class="verifactu-footer">
            <span>Factura verificable en la sede electrónica de la AEAT - VERI*FACTU</span>
        </div>
        -->
    </div>
</body>

</html>