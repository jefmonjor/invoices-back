# Render.com Blueprint - Servicios Secundarios
# Documentación: https://render.com/docs/blueprint-spec
#
# ARQUITECTURA HÍBRIDA:
# - Fly.io (3 servicios principales): Gateway, User, Invoice
# - Render (2 servicios secundarios): Document, Trace
#
# Ventajas:
# - Fly.io: Siempre activo, mejor rendimiento para servicios críticos
# - Render: Ideal para servicios menos críticos, 750h/mes gratis c/u

services:
  # Document Service - Gestión de PDFs y documentos
  - type: web
    name: invoices-document-service
    env: docker
    dockerfilePath: ./document-service/Dockerfile
    dockerContext: ./document-service
    plan: free
    healthCheckPath: /actuator/health
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT
        value: 8083
      - key: EUREKA_CLIENT_ENABLED
        value: false
      - key: SPRING_DATASOURCE_URL
        sync: false  # Configurar con Neon PostgreSQL URL
      - key: JWT_SECRET
        sync: false  # Debe coincidir con el de otros servicios
      - key: JWT_ISSUER
        value: invoices-backend
      - key: S3_ENDPOINT
        sync: false  # Cloudflare R2 endpoint
      - key: S3_ACCESS_KEY
        sync: false  # R2 Access Key
      - key: S3_SECRET_KEY
        sync: false  # R2 Secret Key
      - key: S3_BUCKET_NAME
        value: invoices-documents
      - key: S3_REGION
        value: auto
      - key: S3_PATH_STYLE_ACCESS
        value: false
      - key: LOG_LEVEL_ROOT
        value: INFO
      - key: LOG_LEVEL_APP
        value: DEBUG

  # Trace Service - Auditoría y trazabilidad
  - type: web
    name: invoices-trace-service
    env: docker
    dockerfilePath: ./trace-service/Dockerfile
    dockerContext: ./trace-service
    plan: free
    healthCheckPath: /actuator/health
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: SERVER_PORT
        value: 8084
      - key: EUREKA_CLIENT_ENABLED
        value: false
      - key: SPRING_DATASOURCE_URL
        sync: false  # Configurar con Neon PostgreSQL URL
      - key: JWT_SECRET
        sync: false  # Debe coincidir con el de otros servicios
      - key: JWT_ISSUER
        value: invoices-backend
      - key: REDIS_HOST
        sync: false  # Upstash Redis host
      - key: REDIS_PORT
        value: 6379
      - key: REDIS_PASSWORD
        sync: false  # Upstash Redis password
      - key: REDIS_SSL
        value: true
      - key: REDIS_STREAM_INVOICE_EVENTS
        value: invoice-events
      - key: REDIS_STREAM_INVOICE_DLQ
        value: invoice-events-dlq
      - key: REDIS_CONSUMER_GROUP
        value: trace-group
      - key: REDIS_CONSUMER_NAME
        value: trace-consumer
      - key: LOG_LEVEL_ROOT
        value: INFO
      - key: LOG_LEVEL_APP
        value: DEBUG

# Notas de Deployment:
# 1. Los servicios principales (Gateway, User, Invoice) se despliegan en Fly.io
# 2. Estos servicios secundarios (Document, Trace) se despliegan en Render
# 3. Configurar las mismas variables de entorno en ambas plataformas
# 4. El Gateway debe conocer las URLs de todos los servicios
#
# Free tier limitations:
# - Servicios se duermen después de 15 min de inactividad
# - Primera request después de dormir tarda 30-60 segundos
# - 750 horas gratis por mes por servicio (suficiente para uso moderado)
